<script lang='ts' context='module'>
  import type { TemplateResult, RawJsonResult } from '$lib/models/result.js'
  import type { PopupMenuItem } from '@txstate-mws/svelte-components'
  import { MessageType, type Feedback, type FormStore, type SubmitResponse } from '@txstate-mws/svelte-forms'
  import { isBlank } from 'txstate-utils'
  import { VALIDATE_ONLY, apiURL } from '$lib/util/globals'
  import { FieldHidden, FieldNumber, FieldSelect, FieldStandard, FieldText, Form, Icon, Input } from '@dosgato/dialog'
  import FieldMultiple from './FieldMultiple.svelte'
  import helpCircle from '@iconify-icons/mdi/help-circle'
  import deleteCircle from '@iconify-icons/mdi/delete'

  /**
  ```ts
  {
    url: string
    title: string
    id?: string
    entries: {
      keyphrase: string
      mode: 'keyword'|'phrase'|'exact'
      priority: number
    }[]
    tags?: string[]
    priority?: number
  }
  ``` */
  interface ResultState extends RawJsonResult {
    /** IDs are generated by Mongo/Mongoose and this serves as a placeholder when passed a list of
    entries to populate the form's entries section with for editing. */
    id?: string
  }
  const choices: PopupMenuItem[] = [
    { value: 'keyword', label: 'Keyword' },
    { value: 'phrase', label: 'Phrase' },
    { value: 'exact', label: 'Exact' }
  ]
  function openHelp () {
    const href = 'https://know.tr.txstate.edu/display/MWS/Featured+Search'
    const target = '_blank'
    window.open(href, target)
  }
  const preload = {
    title: 'HomePage',
    url: 'https://www.txstate.edu/',
    entries: [
      { keyphrase: 'Texas State', mode: 'keyword', priority: 50 },
      { keyphrase: 'Test', mode: 'keyword', priority: 50 }
    ]
  }
</script>
<script lang=ts>
  /* TODO:
    1) Fix submit errors. Done. - Need to work out asyoutype validations.
    2) Validate checks with fetches against API.
       - Started adding Feedbacks to API's handling. Still need to pass associated VALIDATE_ONLY param to calls when validating.
    3) Look into CSS nesting with (this is very low priority for now)
      a) different CSS attribute selectors.
        Examples:
        - div[class~='classname'] - for 'classname' being any one of the space separated words in class attribute.
        - div[class|='classname'] - for class value starts with 'classname' optionally followed by hyphenated classname extensions `-.*`
        - div[class*='classname'] - for 'classname' being a substring contained anywhere in the class attribute.
      b) :has(), :is(), and :where() psuedo-selectors.
        Examples:
        - :global(.class1:not(:has(.subclass))) - For making clearer structure refrences.
        - :global(:is(.class1, .class2)) - For grouping common rules with most-specific specificity.
        - :global(:where(.class1, .class2)) - For grouping common rules with zero specificity.
    5) Add interval to 'Save Successful!' that changes it back to 'Save'
       - Might not need to do this. If they start changing inputs validating will change state.
    6) Add confirmation dialog when [Save] is pressed. Possibly the same when [Delete] is pressed
       if they want a [Delete] button for the entire Rusult record.
  */
  import { onMount } from 'svelte'

  /** A `TemplateResult` compatible object to preload the editor form with. */
  export let data: TemplateResult | undefined

  let store: FormStore<ResultState>
  let entries: HTMLElement
  let tagsinputelement: HTMLInputElement = undefined as any

  async function submit (state: ResultState): Promise<SubmitResponse<ResultState>> {
    console.log('ResultEditor.submit => ', JSON.stringify(state))
    const resp = await (await fetch(`${apiURL}/result`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(state)
    })).json()
    console.log('ResultEditor.submit <= RESP: ', JSON.stringify(resp))
    const messages = resp.messages ?? []
    return { success: true, data: resp, messages }
  }

  async function validate (state: ResultState): Promise<Feedback[]> {
    console.log('ResultEditor.validate => ', JSON.stringify(state))
    const resp = await (await fetch(`${apiURL}/result?${VALIDATE_ONLY}`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(state)
    })).json()
    console.log('ResultEditor.validate <= RESP: ', JSON.stringify(resp))
    const messages: Feedback[] = resp.messages ?? []
    console.log('State.id:', state.id ?? '')
    console.log('Resp.id', resp.result?.id)
    if (isBlank(state.id) && resp.result?.id) { // Validation found a pre-existing id for our Result. Add message and add `id` to store.
      messages.push({ type: MessageType.WARNING, path: 'id', message: 'URL corresponds to a pre-existing record.' })
      console.log('url corresponds to a pre-existing Result. Adding `id` to state.')
      // await store.setField('id', resp.result.id)
    }
    return messages
  }

  function tagsSerialize (value: string[]) {
    return value?.join(' ') ?? ''
  }
  function tagsDeserialise (value: string) {
    return value?.split(/[, ]/) ?? []
  }

  onMount(() => {
    /* Remove the empty label from FieldMultiple. */
    Array.from(entries.getElementsByTagName('label')).filter(l => isBlank(l.textContent)).forEach(e => { e.remove() })
    if (data?.id) { console.log('TODO: (Optional) ResultEditor - Race Condition Check Interval') }
    /* Add interval to check for race condition updates to result/[id] and display them to active user.
       Keep in mind that upserts to the Result model already do some checking at .save but it'd be nice
       notify our user that someone else is working on the same Result and what changes they've saved.
       - OR don't waste all the electricity making service calls they can coordinate themselves with so
       few users. */
  })
</script>

<Form bind:store name='result' {submit} {validate} {preload} let:saved>
  <div class='result-form'>
    <FieldText path='title' label='Title:' defaultValue={data?.title ?? ''}/>
    <FieldText path='url' label='URL:' defaultValue={data?.url ?? ''} required/>
    <!-- svelte-forms(entries[]) -->
    <div class='result-entries' bind:this={entries}>
      <div class='label-with-helpicon'>
        <label for={'alias-help'}>Matching Aliases</label>
        <button id='alias-help' type='button' on:click|preventDefault|stopPropagation={openHelp}>
          <Icon icon={helpCircle} hiddenLabel='documentation on search result aliases'/>
        </button>
      </div>
      <FieldMultiple path='entries' label='' removable={true} let:index>
        <div class='result-entries-record'>
          <FieldText path='keyphrase' label='Search Words:' defaultValue={data?.entries?.[index].keyphrase ?? ''} required/>
          <FieldSelect path='mode' label='Mode:' notNull defaultValue={data?.entries?.[index].mode ?? 'keyword'} {choices} required />
          <FieldNumber path='priority' label='Priority:' defaultValue={data?.entries?.[index].priority ?? 50} step={10} required/>
        </div>
        <Icon slot='removeBtnIcon' icon={deleteCircle} hiddenLabel='remove from list'/>
      </FieldMultiple>
    </div>
    <FieldStandard path='tags' label='Administrative Tags:' defaultValue={data?.tags ?? ''} serialize={tagsSerialize} deserialize={tagsDeserialise} let:value let:valid let:invalid let:id let:onBlur let:onChange let:messagesid let:helptextid>
      <Input bind:inputelement={tagsinputelement} name='tags' {value} {id} class="dialog-input" {onChange} {onBlur} {valid} {invalid} {messagesid} {helptextid} ></Input>
    </FieldStandard>
  </div>
  {#if data?.id}<FieldHidden path='id' bind:value={data.id}/>{/if}
  <svelte:fragment slot='submit' let:saved let:submitting let:validating let:valid let:invalid let:allMessages>
    <button class='submit-button' class:validating class:submitting class:saved type='submit'>
      {#if submitting}Submitting...
      {:else if validating}Validating...
      {:else if saved}<span>Save successful!</span>
      {:else}Save
      {/if}
    </button>
  </svelte:fragment>
</Form>

<!-- <style lang="scss"> TODO: I need to get back to translating the below to scss. Lower priority right now. -->
<style>
  .result-form {
    --entries-multiple-spacing: 1.0rem;/*var(--element-container-spacing);   They liked 1.5rem. */
    --padding-between-borders-and-first-container: calc(var(--entries-multiple-spacing) - 0.3rem);
    --padding-between-last-container-and-borders: var(--entries-multiple-spacing);
    --margin-below-borders-and-buttons: calc(var(--margin-below-labels) + 0.1rem);
    --container-borders: 1px solid black;
    --delete-button-offset: 1.3rem;
    --delete-button-top: calc(var(--entries-multiple-spacing) + var(--delete-button-offset));
    --help-icon-size: 0.7rem;
    --border-to-label-spacing: 0.8rem;
    & > div:not(.result-entries) {
      border: none !important;
    }
    & > div:last-of-type {
      margin-bottom: var(--element-container-spacing);
    }
  }
  .result-form :global(.dialog-multiple) {
    --dialog-container-border: none;
    border: none;
  }
  /* All form containers except those nested under result-entries. */
  .result-form :global(.dialog-field-container:not(.result-entries *)) {
    padding: 0 !important;
    margin-top: var(--element-container-spacing);
    & > label {
      margin-bottom: var(--margin-below-labels);
    }
  }
  .result-entries {
    margin-top: var(--element-container-spacing);
    border-top: var(--container-borders);
    padding-top: var(--border-to-label-spacing);
    padding-bottom: var(--element-container-spacing);
    border-bottom: var(--container-borders);
  }
  .label-with-helpicon {
    & > label {
      display: inline-block;
      padding-right: 0;
      margin-bottom: var(--margin-below-labels);
    }
    & > button {
      border: none;
      background: transparent;
      padding: 0;
      cursor: pointer;
      font-size: 1.3rem;
    }
  }
  .label-with-helpicon > button :global(svg) {
    display: inline-block;
    box-sizing: border-box;
    width: var(--help-icon-size);
    height: var(--help-icon-size);
    color: var(--colors-help);
  }
  .result-entries :global(.dialog-field-container) {
    padding: 0 !important;
  }
  .result-entries :global(:not(.result-form) > .dialog-field-container) {
    margin-top: 0 !important;
  }
  .result-entries :global(:not(.result-entries-record .dialog-field-container).dialog-field-container > .dialog-field-label) {
    display: hidden;
    margin: 0;
  }
  .result-entries :global(.dialog-multiple) {
    padding-top: var(--entries-multiple-spacing, 1.5rem);
    padding-left: 0.8rem;
    padding-right: 2rem;
    padding-bottom: 0;
  }
  .result-entries :global(.dialog-multiple:first-child) {
    border-top: var(--top-entries-border, none);
    padding-top: var(--padding-between-borders-and-first-container) !important;
    & > .dialog-multiple-buttons {
      top: calc(var(--padding-between-borders-and-first-container) + var(--delete-button-offset));
    }
  }
  .result-entries :global(.dialog-multiple:last-of-type) {
    padding-bottom: var(--padding-between-last-container-and-borders) !important;
    border-bottom: var(--bottom-entries-border, none);
    margin-bottom: var(--margin-below-borders-and-buttons);
  }
  .result-entries :global(.dialog-multiple-buttons:not(.dialog-field-content > .dialog-multiple:first-child > div)) {
    top: var(--delete-button-top)
  }
  .result-entries :global(.dialog-multiple-buttons > button > svg) {
    color: var(--dg-button-bg);
  }
  .result-entries-record {
    display: flex;
  }
  .result-entries-record :global(.dialog-field-container) {
    margin-bottom: 0 !important;
    & select {
      margin-bottom: 0 !important;
      padding: 0.2rem 0.5rem;
    }
    /*& > label {
      display: none;
    }*/
  }
  /* Search Words */
  .result-entries-record :global(.dialog-field-container:first-child) {
    flex-grow: 1;
  }
  /* Mode */
  .result-entries-record :global(.dialog-field-container:nth-child(2)) {
    width: 7rem;
  }
  /* Priority */
  .result-entries-record :global(.dialog-field-container:last-child) {
    width: 5rem;
  }
  /* Spacing between the above inputs. */
  .result-entries-record :global(.dialog-field-container:not(:last-child)) {
    margin-right: 0.5rem !important;
  }
  .submit-button {
    margin-bottom: 1rem;
  }
</style>
